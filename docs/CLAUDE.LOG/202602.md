# 2026-02 開發日誌

## 2026-02-21：T8 Gateway 原生 WS 訂閱推播

### 目標

將訊息串流架構從「per-request SSE + polling fallback」升級為「推播優先」：
AP 端對每個 token 的 WS 連線常駐訂閱 Gateway 事件，前端透過持久 SSE 通道即時接收，
不再依賴每次發送訊息時才建立的短暫 SSE 連線。polling 僅作為最後保底。

### 設計決策

1. **為何不用 EventSource API？** — EventSource 不支援自訂 Authorization header，
   改用 fetch + ReadableStream 手動解析 SSE 格式，同時支援斷線自動重連（指數退避）。

2. **推播模式下的發送流程簡化** — 持久 SSE 在線時，前端僅需 `POST /messages`（REST），
   chunk 由持久 SSE 通道自動推入，無需建立 per-request SSE 連線。
   設有 30 秒逾時保底，若 message-final 未到達則 fallback 重載訊息。

3. **EventForwarder 架構** — AP 端新增 EventForwarder 類別，
   以 token 為 key 管理 SSE 客戶端集合。第一個客戶端連上時建立 WS 事件訂閱，
   最後一個客戶端斷開時取消訂閱，避免無謂的記憶體佔用。

4. **完整 fallback 保留** — 持久 SSE 離線時，自動回退至原有的
   per-request SSE stream + REST polling 流程，確保可靠性。

### 檔案變更

**新增：**
- `apps/api/src/event-forwarder.ts` — 持久事件轉發器（token → SSE 客戶端映射 + 常駐 Gateway 訂閱）
- `apps/api/src/routes/events.ts` — `GET /api/events` 持久 SSE 端點（含 30 秒 keepalive）
- `apps/web/src/api/event-source.ts` — 持久 SSE 消費模組（fetch+ReadableStream，指數退避重連）

**修改：**
- `apps/api/src/index.ts` — 掛載 `/api/events` 路由
- `apps/api/src/gateway-rpc.ts` — 移除 T8 偵測用 debug logger
- `apps/web/src/stores/sessions.ts` — 新增 `initEventStream()`、`eventStreamConnected` 狀態；
  `sendMessage()` 推播優先邏輯；`reset()` 斷開持久 SSE
- `apps/web/src/views/ChatView.vue` — `onMounted` 啟動事件流；`transportMode` 新增 `'push'` 值與樣式

### 推播事件格式（AP → 前端）

| type | 說明 |
|---|---|
| `chunk` | 逐 token 串流文字 delta |
| `agent-start` | AI 回覆開始 |
| `agent-end` | AI 回覆結束 |
| `message-final` | 完成訊息（觸發訊息重載） |
| `keepalive` | 30 秒心跳（防止連線超時） |

### 傳輸模式指示

前端 transport badge 現有四種狀態：
- **push**（藍色）— 持久 SSE 推播模式
- **stream**（綠色）— per-request SSE 串流 fallback
- **fallback**（橘色）— REST + polling fallback
- **idle** — 閒置

---

## 2026-02-21：T9 Session 標題內聯編輯

### 目標

使用者可在側邊欄直接重新命名 Session 標題，標題透過 Gateway RPC 持久化儲存，
與 OpenClaw Dashboard 行為一致。

### 設計決策

1. **Gateway RPC 方法選擇** — 初次嘗試 `sessions.update` 失敗（`unknown method`），
   查閱 OpenClaw Control UI 文件後確認正確方法為 `sessions.patch`，
   params 格式為 `{ key: sessionKey, label: title }`。
   曾短暫實作 AP in-memory fallback，確認 RPC 可用後移除。

2. **PATCH 路由擴充策略** — 將既有的 `PATCH /api/sessions/:sessionKey`
   從僅支援 `{ archived }` 擴充為同時支援 `{ title }` 和 `{ archived }`，
   兩欄位各自獨立處理，可同時或單獨傳送，無需新增端點。

3. **內聯編輯 UX** — 點擊 ✎ 按鈕後標題文字替換為 `<input>`，
   自動聚焦並選取全文。Enter/blur 確認、Escape 取消，
   空白標題和未變更標題不送出 API 呼叫。

### 檔案變更

**修改：**
- `apps/api/src/session-manager.ts` — 新增 `rename()` 方法，呼叫 `sessions.patch` RPC
- `apps/api/src/gateway.ts` — 新增 `renameSession()` facade
- `apps/api/src/routes/sessions.ts` — 擴充 PATCH 路由，支援 `title` + `archived` 雙欄位
- `apps/web/src/api/client.ts` — 新增 `renameSession()` API 呼叫
- `apps/web/src/stores/sessions.ts` — 新增 `renameSession()` action、`renamingSessionKey`/`renameError` 狀態
- `apps/web/src/views/ChatView.vue` — 新增 ✎ 編輯按鈕、`<input>` 內聯編輯模式、聚焦/選取/確認/取消邏輯

### 踩坑紀錄

| 嘗試 | 結果 | 解法 |
|---|---|---|
| `sessions.update` RPC | `unknown method` | 改用 `sessions.patch`（來自 Control UI 文件） |
| AP in-memory fallback | 可行但重啟後重置 | 確認 `sessions.patch` 可用後移除 |

---

## 2026-02-21：本輪收斂紀錄

### Baseline

- **Commit**: `e787a41` — Update: 支援 Session 標題內聯編輯功能
- **Build**: `npm run build` 全部通過（API tsc 0 錯誤、Web vue-tsc + vite 39 modules）
- **完成任務**: T0–T9 全部完成

### 驗證結果摘要

| 功能 | 狀態 | 備註 |
|---|---|---|
| push 模式 | ✅ 正常 | 持久 SSE 在線時，chunk 即時推播 |
| per-request SSE fallback | ✅ 正常 | 持久 SSE 離線時自動降級 |
| REST + polling fallback | ✅ 正常 | 間隔 2 秒，最長 30 秒 |
| Token 過期自動登出 | ✅ 正常 | 401 → 自動登出 → 登入頁提示 |
| Session 標題內聯編輯 | ✅ 正常 | `sessions.patch` RPC 63ms，Gateway 持久化 |
| 封存 / 關閉 Session | ✅ 正常 | 封存為 AP in-memory、關閉為 Gateway RPC |

### 已知限制

1. **封存狀態不持久**：AP in-memory，重啟後重置
2. **Gateway 串流事件格式為推測值**：`chat.stream` / `chat.chunk` 名稱與 payload 需依實際規格調整
3. **SSE 串流前端無法中途取消**：需等 done 或 error 才結束
4. **圖片以 base64 傳送**：若 Gateway 期待二進位 WS frame，需調整

### 下一步建議

1. 推播事件 schema 穩定化（確認 Gateway 實際事件名稱與 payload）
2. `/health` 端點暴露 WS 連線池與 SSE 客戶端觀測指標
3. SSE 串流前端中途取消機制
4. 生產環境改用 `wss://` + `TLS_VERIFY=true`
